import { Subject, Observable, BehaviorSubject } from 'rxjs';
import { TSMap } from 'typescript-map';
import { RadixSpin, RadixTransferrableTokensParticle, RadixUniqueParticle, } from '../atommodel';
import { RadixDecryptionState } from './RadixDecryptionAccountSystem';
import BN from 'bn.js';
import { radixTokenManager } from '../token/RadixTokenManager';
import Decimal from 'decimal.js';
import { RadixTokenDefinition } from '../token/RadixTokenDefinition';
export default class RadixTransferAccountSystem {
    constructor(address) {
        this.address = address;
        this.name = 'TRANSFER';
        this.transactions = new TSMap();
        this.balance = {};
        this.tokenUnitsBalance = {};
        this.transactionSubject = new Subject();
        this.unspentConsumables = new TSMap();
        this.spentConsumables = new TSMap();
        // Add default radix token to balance
        this.balance[radixTokenManager.nativeToken.toString()] = new BN(0);
        this.balanceSubject = new BehaviorSubject(this.balance);
        this.tokenUnitsBalance[radixTokenManager.nativeToken.toString()] = new Decimal(0);
        this.tokenUnitsBalanceSubject = new BehaviorSubject(this.tokenUnitsBalance);
    }
    async processAtomUpdate(atomUpdate) {
        const atom = atomUpdate.atom;
        if (!atom.containsParticle(RadixTransferrableTokensParticle)) {
            return;
        }
        if (atomUpdate.action === 'STORE') {
            await this.processStoreAtom(atomUpdate);
        }
        else if (atomUpdate.action === 'DELETE') {
            await this.processDeleteAtom(atomUpdate);
        }
    }
    async processStoreAtom(atomUpdate) {
        const atom = atomUpdate.atom;
        // Skip existing atoms
        if (this.transactions.has(atom.getAidString())) {
            return;
        }
        const transactionUpdate = {
            action: 'STORE',
            aid: atom.getAidString(),
            transaction: {
                aid: atom.getAidString(),
                balance: {},
                tokenUnitsBalance: {},
                fee: 0,
                participants: {},
                timestamp: atom.getTimestamp(),
                message: '',
                unique: atom.getParticlesOfType(RadixUniqueParticle).map(p => p.getRRI().toString()),
            },
        };
        const transaction = transactionUpdate.transaction;
        // Get transaction message
        if (atomUpdate.processedData.decryptedData
            && atomUpdate.processedData.decryptedData.decryptionState !== RadixDecryptionState.CANNOT_DECRYPT) {
            transaction.message = atomUpdate.processedData.decryptedData.data;
        }
        const consumables = atom.getSpunParticlesOfType(RadixTransferrableTokensParticle);
        // Get transaction details
        for (const consumable of consumables) {
            const spin = consumable.spin;
            const particle = consumable.particle;
            const tokenClassReference = particle.getTokenDefinitionReference();
            const ownedByMe = particle.getOwner().equals(this.address);
            // TODO: Implement Fees when they change to token fees
            // Assumes POW fee
            if (ownedByMe) {
                const quantity = new BN(0);
                const hid = particle.getHidString();
                if (spin === RadixSpin.DOWN) {
                    quantity.isub(particle.getAmount());
                    this.unspentConsumables.delete(hid);
                    this.spentConsumables.set(hid, particle);
                }
                else if (spin === RadixSpin.UP) {
                    quantity.iadd(particle.getAmount());
                    if (!this.spentConsumables.has(hid)) {
                        this.unspentConsumables.set(hid, particle);
                    }
                }
                if (!(tokenClassReference.toString() in transaction.balance)) {
                    transaction.balance[tokenClassReference.toString()] = new BN(0);
                }
                transaction.balance[tokenClassReference.toString()].iadd(quantity);
            }
            else {
                transaction.participants[particle.getOwner().toString()] = particle.getOwner();
            }
        }
        // Not a transfer
        if (Object.keys(transaction.balance).length === 0) {
            return;
        }
        const numberOfParticipants = Object.keys(transaction.participants).length;
        if (numberOfParticipants > 2) {
            throw new Error(`Invalid number of transaction participants = ${numberOfParticipants}`);
        }
        // Update balance
        for (const tokenId in transaction.balance) {
            // Load tokenclass from network
            // const tokenClass = await radixTokenManager.getTokenClass(tokenId)
            if (!(tokenId in this.balance) || !this.balance[tokenId]) {
                this.balance[tokenId] = new BN(0);
            }
            this.balance[tokenId].iadd(transaction.balance[tokenId]);
            // Token units
            transaction.tokenUnitsBalance[tokenId] = RadixTokenDefinition.fromSubunitsToDecimal(transaction.balance[tokenId]);
            if (!(tokenId in this.tokenUnitsBalance) || !this.balance[tokenId]) {
                this.tokenUnitsBalance[tokenId] = new Decimal(0);
            }
            this.tokenUnitsBalance[tokenId] = this.tokenUnitsBalance[tokenId].add(transaction.tokenUnitsBalance[tokenId]);
        }
        this.transactions.set(transactionUpdate.aid, transaction);
        this.balanceSubject.next(this.balance);
        this.tokenUnitsBalanceSubject.next(this.tokenUnitsBalance);
        this.transactionSubject.next(transactionUpdate);
    }
    async processDeleteAtom(atomUpdate) {
        const atom = atomUpdate.atom;
        // Skip nonexisting atoms
        if (!this.transactions.has(atom.getAidString())) {
            return;
        }
        const id = atom.getAidString();
        const transaction = this.transactions.get(id);
        const transactionUpdate = {
            action: 'DELETE',
            aid: id,
            transaction,
        };
        // Update balance
        for (const tokenId in transaction.balance) {
            // Load tokenclass from network
            // const tokenClass = await radixTokenManager.getTokenClass(tokenId)
            if (!(tokenId in this.balance) || !this.balance[tokenId]) {
                this.balance[tokenId] = new BN(0);
            }
            this.balance[tokenId].isub(transaction.balance[tokenId]);
            // Token units
            transaction.tokenUnitsBalance[tokenId] = RadixTokenDefinition.fromSubunitsToDecimal(transaction.balance[tokenId]);
            if (!(tokenId in this.tokenUnitsBalance) || !this.balance[tokenId]) {
                this.tokenUnitsBalance[tokenId] = new Decimal(0);
            }
            this.tokenUnitsBalance[tokenId] = this.tokenUnitsBalance[tokenId].sub(transaction.tokenUnitsBalance[tokenId]);
        }
        this.transactions.delete(transactionUpdate.aid);
        this.balanceSubject.next(this.balance);
        this.tokenUnitsBalanceSubject.next(this.tokenUnitsBalance);
        this.transactionSubject.next(transactionUpdate);
    }
    getAllTransactions() {
        return Observable.create((observer) => {
            // Send all old transactions
            for (const transaction of this.transactions.values()) {
                const transactionUpdate = {
                    action: 'STORE',
                    aid: transaction.aid,
                    transaction,
                };
                observer.next(transactionUpdate);
            }
            // Subscribe for new ones
            this.transactionSubject.subscribe(observer);
        });
    }
    getUnspentConsumables() {
        return this.unspentConsumables.values();
    }
    getTokenUnitsBalanceUpdates() {
        return this.tokenUnitsBalanceSubject.share();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmFkaXhUcmFuc2ZlckFjY291bnRTeXN0ZW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kdWxlcy9hY2NvdW50L1JhZGl4VHJhbnNmZXJBY2NvdW50U3lzdGVtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFZLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQTtBQUNyRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFNdEMsT0FBTyxFQUdILFNBQVMsRUFDVCxnQ0FBZ0MsRUFFaEMsbUJBQW1CLEdBQ3RCLE1BQU0sY0FBYyxDQUFBO0FBQ3JCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRXRFLE9BQU8sRUFBRSxNQUFNLE9BQU8sQ0FBQTtBQUN0QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMvRCxPQUFPLE9BQU8sTUFBTSxZQUFZLENBQUM7QUFDakMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFckUsTUFBTSxDQUFDLE9BQU8sT0FBTywwQkFBMEI7SUFjM0MsWUFBcUIsT0FBcUI7UUFBckIsWUFBTyxHQUFQLE9BQU8sQ0FBYztRQWJuQyxTQUFJLEdBQUcsVUFBVSxDQUFBO1FBRWpCLGlCQUFZLEdBQW9DLElBQUksS0FBSyxFQUFFLENBQUE7UUFDM0QsWUFBTyxHQUE4QixFQUFFLENBQUE7UUFDdkMsc0JBQWlCLEdBQW1DLEVBQUUsQ0FBQTtRQUV0RCx1QkFBa0IsR0FBb0MsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUlsRSx1QkFBa0IsR0FBbUMsSUFBSSxLQUFLLEVBQUUsQ0FBQTtRQUNoRSxxQkFBZ0IsR0FBbUMsSUFBSSxLQUFLLEVBQUUsQ0FBQTtRQUdsRSxxQ0FBcUM7UUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxX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