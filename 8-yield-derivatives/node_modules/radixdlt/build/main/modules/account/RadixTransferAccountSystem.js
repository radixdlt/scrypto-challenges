"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var rxjs_1 = require("rxjs");
var typescript_map_1 = require("typescript-map");
var atommodel_1 = require("../atommodel");
var RadixDecryptionAccountSystem_1 = require("./RadixDecryptionAccountSystem");
var bn_js_1 = tslib_1.__importDefault(require("bn.js"));
var RadixTokenManager_1 = require("../token/RadixTokenManager");
var decimal_js_1 = tslib_1.__importDefault(require("decimal.js"));
var RadixTokenDefinition_1 = require("../token/RadixTokenDefinition");
var RadixTransferAccountSystem = /** @class */ (function () {
    function RadixTransferAccountSystem(address) {
        this.address = address;
        this.name = 'TRANSFER';
        this.transactions = new typescript_map_1.TSMap();
        this.balance = {};
        this.tokenUnitsBalance = {};
        this.transactionSubject = new rxjs_1.Subject();
        this.unspentConsumables = new typescript_map_1.TSMap();
        this.spentConsumables = new typescript_map_1.TSMap();
        // Add default radix token to balance
        this.balance[RadixTokenManager_1.radixTokenManager.nativeToken.toString()] = new bn_js_1.default(0);
        this.balanceSubject = new rxjs_1.BehaviorSubject(this.balance);
        this.tokenUnitsBalance[RadixTokenManager_1.radixTokenManager.nativeToken.toString()] = new decimal_js_1.default(0);
        this.tokenUnitsBalanceSubject = new rxjs_1.BehaviorSubject(this.tokenUnitsBalance);
    }
    RadixTransferAccountSystem.prototype.processAtomUpdate = function (atomUpdate) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var atom;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        atom = atomUpdate.atom;
                        if (!atom.containsParticle(atommodel_1.RadixTransferrableTokensParticle)) {
                            return [2 /*return*/];
                        }
                        if (!(atomUpdate.action === 'STORE')) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.processStoreAtom(atomUpdate)];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 2:
                        if (!(atomUpdate.action === 'DELETE')) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.processDeleteAtom(atomUpdate)];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    RadixTransferAccountSystem.prototype.processStoreAtom = function (atomUpdate) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var atom, transactionUpdate, transaction, consumables, consumables_1, consumables_1_1, consumable, spin, particle, tokenClassReference, ownedByMe, quantity, hid, numberOfParticipants, tokenId;
            var e_1, _a;
            return tslib_1.__generator(this, function (_b) {
                atom = atomUpdate.atom;
                // Skip existing atoms
                if (this.transactions.has(atom.getAidString())) {
                    return [2 /*return*/];
                }
                transactionUpdate = {
                    action: 'STORE',
                    aid: atom.getAidString(),
                    transaction: {
                        aid: atom.getAidString(),
                        balance: {},
                        tokenUnitsBalance: {},
                        fee: 0,
                        participants: {},
                        timestamp: atom.getTimestamp(),
                        message: '',
                        unique: atom.getParticlesOfType(atommodel_1.RadixUniqueParticle).map(function (p) { return p.getRRI().toString(); }),
                    },
                };
                transaction = transactionUpdate.transaction;
                // Get transaction message
                if (atomUpdate.processedData.decryptedData
                    && atomUpdate.processedData.decryptedData.decryptionState !== RadixDecryptionAccountSystem_1.RadixDecryptionState.CANNOT_DECRYPT) {
                    transaction.message = atomUpdate.processedData.decryptedData.data;
                }
                consumables = atom.getSpunParticlesOfType(atommodel_1.RadixTransferrableTokensParticle);
                try {
                    // Get transaction details
                    for (consumables_1 = tslib_1.__values(consumables), consumables_1_1 = consumables_1.next(); !consumables_1_1.done; consumables_1_1 = consumables_1.next()) {
                        consumable = consumables_1_1.value;
                        spin = consumable.spin;
                        particle = consumable.particle;
                        tokenClassReference = particle.getTokenDefinitionReference();
                        ownedByMe = particle.getOwner().equals(this.address);
                        // TODO: Implement Fees when they change to token fees
                        // Assumes POW fee
                        if (ownedByMe) {
                            quantity = new bn_js_1.default(0);
                            hid = particle.getHidString();
                            if (spin === atommodel_1.RadixSpin.DOWN) {
                                quantity.isub(particle.getAmount());
                                this.unspentConsumables.delete(hid);
                                this.spentConsumables.set(hid, particle);
                            }
                            else if (spin === atommodel_1.RadixSpin.UP) {
                                quantity.iadd(particle.getAmount());
                                if (!this.spentConsumables.has(hid)) {
                                    this.unspentConsumables.set(hid, particle);
                                }
                            }
                            if (!(tokenClassReference.toString() in transaction.balance)) {
                                transaction.balance[tokenClassReference.toString()] = new bn_js_1.default(0);
                            }
                            transaction.balance[tokenClassReference.toString()].iadd(quantity);
                        }
                        else {
                            transaction.participants[particle.getOwner().toString()] = particle.getOwner();
                        }
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (consumables_1_1 && !consumables_1_1.done && (_a = consumables_1.return)) _a.call(consumables_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                // Not a transfer
                if (Object.keys(transaction.balance).length === 0) {
                    return [2 /*return*/];
                }
                numberOfParticipants = Object.keys(transaction.participants).length;
                if (numberOfParticipants > 2) {
                    throw new Error("Invalid number of transaction participants = " + numberOfParticipants);
                }
                // Update balance
                for (tokenId in transaction.balance) {
                    // Load tokenclass from network
                    // const tokenClass = await radixTokenManager.getTokenClass(tokenId)
                    if (!(tokenId in this.balance) || !this.balance[tokenId]) {
                        this.balance[tokenId] = new bn_js_1.default(0);
                    }
                    this.balance[tokenId].iadd(transaction.balance[tokenId]);
                    // Token units
                    transaction.tokenUnitsBalance[tokenId] = RadixTokenDefinition_1.RadixTokenDefinition.fromSubunitsToDecimal(transaction.balance[tokenId]);
                    if (!(tokenId in this.tokenUnitsBalance) || !this.balance[tokenId]) {
                        this.tokenUnitsBalance[tokenId] = new decimal_js_1.default(0);
                    }
                    this.tokenUnitsBalance[tokenId] = this.tokenUnitsBalance[tokenId].add(transaction.tokenUnitsBalance[tokenId]);
                }
                this.transactions.set(transactionUpdate.aid, transaction);
                this.balanceSubject.next(this.balance);
                this.tokenUnitsBalanceSubject.next(this.tokenUnitsBalance);
                this.transactionSubject.next(transactionUpdate);
                return [2 /*return*/];
            });
        });
    };
    RadixTransferAccountSystem.prototype.processDeleteAtom = function (atomUpdate) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var atom, id, transaction, transactionUpdate, tokenId;
            return tslib_1.__generator(this, function (_a) {
                atom = atomUpdate.atom;
                // Skip nonexisting atoms
                if (!this.transactions.has(atom.getAidString())) {
                    return [2 /*return*/];
                }
                id = atom.getAidString();
                transaction = this.transactions.get(id);
                transactionUpdate = {
                    action: 'DELETE',
                    aid: id,
                    transaction: transaction,
                };
                // Update balance
                for (tokenId in transaction.balance) {
                    // Load tokenclass from network
                    // const tokenClass = await radixTokenManager.getTokenClass(tokenId)
                    if (!(tokenId in this.balance) || !this.balance[tokenId]) {
                        this.balance[tokenId] = new bn_js_1.default(0);
                    }
                    this.balance[tokenId].isub(transaction.balance[tokenId]);
                    // Token units
                    transaction.tokenUnitsBalance[tokenId] = RadixTokenDefinition_1.RadixTokenDefinition.fromSubunitsToDecimal(transaction.balance[tokenId]);
                    if (!(tokenId in this.tokenUnitsBalance) || !this.balance[tokenId]) {
                        this.tokenUnitsBalance[tokenId] = new decimal_js_1.default(0);
                    }
                    this.tokenUnitsBalance[tokenId] = this.tokenUnitsBalance[tokenId].sub(transaction.tokenUnitsBalance[tokenId]);
                }
                this.transactions.delete(transactionUpdate.aid);
                this.balanceSubject.next(this.balance);
                this.tokenUnitsBalanceSubject.next(this.tokenUnitsBalance);
                this.transactionSubject.next(transactionUpdate);
                return [2 /*return*/];
            });
        });
    };
    RadixTransferAccountSystem.prototype.getAllTransactions = function () {
        var _this = this;
        return rxjs_1.Observable.create(function (observer) {
            var e_2, _a;
            try {
                // Send all old transactions
                for (var _b = tslib_1.__values(_this.transactions.values()), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var transaction = _c.value;
                    var transactionUpdate = {
                        action: 'STORE',
                        aid: transaction.aid,
                        transaction: transaction,
                    };
                    observer.next(transactionUpdate);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_2) throw e_2.error; }
            }
            // Subscribe for new ones
            _this.transactionSubject.subscribe(observer);
        });
    };
    RadixTransferAccountSystem.prototype.getUnspentConsumables = function () {
        return this.unspentConsumables.values();
    };
    RadixTransferAccountSystem.prototype.getTokenUnitsBalanceUpdates = function () {
        return this.tokenUnitsBalanceSubject.share();
    };
    return RadixTransferAccountSystem;
}());
exports.default = RadixTransferAccountSystem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmFkaXhUcmFuc2ZlckFjY291bnRTeXN0ZW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kdWxlcy9hY2NvdW50L1JhZGl4VHJhbnNmZXJBY2NvdW50U3lzdGVtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUFxRTtBQUNyRSxpREFBc0M7QUFNdEMsMENBT3FCO0FBQ3JCLCtFQUFzRTtBQUV0RSx3REFBc0I7QUFDdEIsZ0VBQStEO0FBQy9ELGtFQUFpQztBQUNqQyxzRUFBcUU7QUFFckU7SUFjSSxvQ0FBcUIsT0FBcUI7UUFBckIsWUFBTyxHQUFQLE9BQU8sQ0FBYztRQWJuQyxTQUFJLEdBQUcsVUFBVSxDQUFBO1FBRWpCLGlCQUFZLEdBQW9DLElBQUksc0JBQUssRUFBRSxDQUFBO1FBQzNELFlBQU8sR0FBOEIsRUFBRSxDQUFBO1FBQ3ZDLHNCQUFpQixHQUFtQyxFQUFFLENBQUE7UUFFdEQsdUJBQWtCLEdBQW9DLElBQUksY0FBTyxFQUFFLENBQUE7UUFJbEUsdUJBQWtCLEdBQW1DLElBQUksc0JBQUssRUFBRSxDQUFBO1FBQ2hFLHFCQUFnQixHQUFtQyxJQUFJLHNCQUFLLEVBQUUsQ0FBQTtRQUdsRSxxQ0FBcUM7UUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxxQ0FBaUIsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxJQUFJLGVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNsRSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksc0JBQWUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFFdkQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHFDQUFpQixDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLElBQUksb0JBQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNqRixJQUFJLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxzQkFBZSxDQUFDLElBQUksQ0FBQyxpQkFB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