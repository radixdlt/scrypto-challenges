"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var Rx_1 = require("rxjs/Rx");
var rpc_websockets_1 = require("rpc-websockets");
var atommodel_1 = require("../atommodel");
var RadixLogger_1 = require("../common/RadixLogger");
var events_1 = tslib_1.__importDefault(require("events"));
var RadixNodeConnection = /** @class */ (function (_super) {
    tslib_1.__extends(RadixNodeConnection, _super);
    function RadixNodeConnection(node) {
        var _this = _super.call(this) || this;
        _this.node = node;
        _this._subscriptions = {};
        _this._atomUpdateSubjects = {};
        _this._addressSubscriptions = {};
        _this.lastSubscriberId = 1;
        _this.ping = function () {
            if (_this.isReady()) {
                _this._socket
                    .call('Ping', { id: 0 }).then(function (response) {
                    RadixLogger_1.logger.debug("Ping", response);
                }).catch(function (error) {
                    RadixLogger_1.logger.warn("Error sending ping", error);
                });
            }
        };
        _this.close = function () {
            _this._socket.close();
            clearInterval(_this.pingInterval);
        };
        _this._onClosed = function () {
            RadixLogger_1.logger.info('Socket closed');
            clearInterval(_this.pingInterval);
            // Close subject
            for (var subscriberId in _this._subscriptions) {
                var subscription = _this._subscriptions[subscriberId];
                if (!subscription.closed) {
                    subscription.error('Socket closed');
                }
            }
            for (var subscriberId in _this._atomUpdateSubjects) {
                var subject = _this._atomUpdateSubjects[subscriberId];
                if (!subject.closed) {
                    subject.error('Socket closed');
                }
            }
            _this.emit('closed');
        };
        _this._onAtomStatusNotification = function (notification) {
            RadixLogger_1.logger.info('Atom Status notification', notification);
            // Handle atom state update
            var subscriberId = notification.subscriberId;
            var value = notification.status;
            var message = JSON.stringify(notification.data);
            var subject = _this._atomUpdateSubjects[subscriberId];
            switch (value) {
                case 'STORED':
                    subject.next(value);
                    subject.complete();
                    break;
                case 'EVICTED_CONFLICT_LOSER':
                case 'EVICTED_FAILED_CM_VERIFICATION':
                case 'MISSING_DEPEPENDENCY':
                case 'CONFLICT_LOSER':
                    subject.error(value + ': ' + message);
                    break;
            }
        };
        _this._onAtomSubmissionStateUpdate = function (notification) {
            RadixLogger_1.logger.info('Atom Submission state update', notification);
            // Handle atom state update
            var subscriberId = notification.subscriberId;
            var value = notification.value;
            var message = JSON.stringify(notification.data);
            var subject = _this._atomUpdateSubjects[subscriberId];
            switch (value) {
                case 'SUBMITTING':
                case 'SUBMITTED':
                    subject.next(value);
                    break;
                case 'STORED':
                    subject.next(value);
                    subject.complete();
                    break;
                case 'COLLISION':
                case 'ILLEGAL_STATE':
                case 'UNSUITABLE_PEER':
                case 'VALIDATION_ERROR':
                    subject.error(value + ': ' + message);
                    break;
            }
        };
        _this._onAtomReceivedNotification = function (notification) {
            var e_1, _a;
            RadixLogger_1.logger.debug('Atoms notification', notification);
            // Store atom for testing
            // const jsonPath = `./atomNotification-${Math.random().toString(36).substring(6)}.json`
            // // let jsonPath = path.join(__dirname, '..', '..', '..', '..', 'atomNotification.json')
            // logger.info(jsonPath)
            // fs.writeFile(jsonPath, JSON.stringify(notification), (error) => {
            //    // Throws an error, you could also catch it here
            //    if (error) { throw error }
            //    // Success case, the file was saved
            //    logger.info('Atoms saved!')
            // })
            var deserializedAtomEvents = atommodel_1.RadixSerializer.fromJSON(notification.atomEvents);
            RadixLogger_1.logger.debug('Recieved atom AIDs, subscriberId: ' + notification.subscriberId, deserializedAtomEvents.map(function (event) {
                return { aid: event.atom.getAidString(), type: event.type };
            }));
            // logger.debug('AtomEvents', deserializedAtomEvents)
            // Forward atoms to correct wallets
            var subscription = _this._subscriptions[notification.subscriberId];
            try {
                for (var deserializedAtomEvents_1 = tslib_1.__values(deserializedAtomEvents), deserializedAtomEvents_1_1 = deserializedAtomEvents_1.next(); !deserializedAtomEvents_1_1.done; deserializedAtomEvents_1_1 = deserializedAtomEvents_1.next()) {
                    var event_1 = deserializedAtomEvents_1_1.value;
                    subscription.next({
                        action: event_1.type.toUpperCase(),
                        atom: event_1.atom,
                        processedData: {},
                        // Only set to head if it is the last atom of an update
                        isHead: event_1 === deserializedAtomEvents[deserializedAtomEvents.length - 1],
                    });
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (deserializedAtomEvents_1_1 && !deserializedAtomEvents_1_1.done && (_a = deserializedAtomEvents_1.return)) _a.call(deserializedAtomEvents_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        };
        _this.node = node;
        return _this;
    }
    RadixNodeConnection.prototype.getSubscriberId = function () {
        this.lastSubscriberId++;
        return this.lastSubscriberId + '';
    };
    /**
     * Check whether the node connection is ready for requests
     * @returns true if ready
     */
    RadixNodeConnection.prototype.isReady = function () {
        return this._socket && this._socket.ready;
    };
    /**
     * Opens connection
     * @returns a promise that resolves once the connection is ready, or rejects on error or timeout
     */
    RadixNodeConnection.prototype.openConnection = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        _this.address = _this.node.wsAddress;
                        // For testing atom queueing during connection issues
                        // if (Math.random() > 0.1) {
                        //    this.address += 'garbage'
                        // }
                        RadixLogger_1.logger.info("Connecting to " + _this.address);
                        _this._socket = new rpc_websockets_1.Client(_this.address, { reconnect: false });
                        _this._socket.on('close', _this._onClosed);
                        _this._socket.on('error', function (error) {
                            RadixLogger_1.logger.error(error);
                            reject(error);
                        });
                        setTimeout(function () {
                            if (!_this._socket.ready) {
                                RadixLogger_1.logger.debug('Socket timeout');
                                _this._socket.close();
                                _this.emit('closed');
                                reject('Timeout');
                            }
                        }, 5000);
                        _this._socket.on('open', function () {
                            RadixLogger_1.logger.info("Connected to " + _this.address);
                            _this.pingInterval = setInterval(_this.ping, 10000);
                            _this.emit('open');
                            _this._socket.on('Atoms.subscribeUpdate', _this._onAtomReceivedNotification);
                            _this._socket.on('AtomSubmissionState.onNext', _this._onAtomSubmissionStateUpdate);
                            _this._socket.on('Atoms.nextStatusEvent', _this._onAtomStatusNotification);
                            resolve();
                        });
                    })];
            });
        });
    };
    /**
     * Subscribe for all existing and future atoms for a given address
     *
     * @param address Base58 formatted address
     * @returns A stream of atoms
     */
    RadixNodeConnection.prototype.subscribe = function (address) {
        var _this = this;
        var subscriberId = this.getSubscriberId();
        this._addressSubscriptions[address] = subscriberId;
        this._subscriptions[subscriberId] = new Rx_1.Subject();
        this._socket
            .call('Atoms.subscribe', {
            subscriberId: subscriberId,
            query: {
                address: address,
            },
            debug: true,
        })
            .then(function (response) {
            RadixLogger_1.logger.info("Subscribed for address " + address, response);
        })
            .catch(function (error) {
            RadixLogger_1.logger.error("Error subscribing for address " + address, error);
            _this._subscriptions[subscriberId].error(error);
        });
        return this._subscriptions[subscriberId];
    };
    /**
     * Unsubscribe for all existing and future atoms for a given address
     *
     * @param address - Base58 formatted address
     * @returns A promise with the result of the unsubscription call
     */
    RadixNodeConnection.prototype.unsubscribe = function (address) {
        var _this = this;
        var subscriberId = this._addressSubscriptions[address];
        return new Promise(function (resolve, reject) {
            _this._socket
                .call('Atoms.cancel', {
                subscriberId: subscriberId,
            })
                .then(function (response) {
                RadixLogger_1.logger.info("Unsubscribed for address " + address);
                _this._subscriptions[_this._addressSubscriptions[address]].complete();
                delete _this._addressSubscriptions[address];
                resolve(response);
            })
                .catch(function (error) {
                reject(error);
            });
        });
    };
    /**
     * Unsubscribes to all the addresses this node is subscribed to
     *
     * @returns An array with the result of each unsubscription
     */
    RadixNodeConnection.prototype.unsubscribeAll = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var unsubscriptions = new Array();
            for (var address in _this._addressSubscriptions) {
                unsubscriptions.push(_this.unsubscribe(address));
            }
            Promise.all(unsubscriptions)
                .then(function (values) {
                resolve(values);
            })
                .catch(function (error) {
                reject(error);
            });
        });
    };
    /**
     * Submit an atom to the ledger
     *
     * @param atom - The atom to be submitted
     * @returns A stream of the status of the atom submission
     */
    RadixNodeConnection.prototype.submitAtom = function (atom) {
        // // Store atom for testing
        // let jsonPath = path.join('./submitAtom.json')
        // logger.info(jsonPath)
        // fs.writeFile(jsonPath, JSON.stringify(atom.toJSON()), (error) => {
        //    // Throws an error, you could also catch it here
        //    if (error) { throw error }
        var _this = this;
        //    // Success case, the file was saved
        //    logger.info('Atom saved!')
        // })
        var subscriberId = this.getSubscriberId();
        var atomStateSubject = new Rx_1.BehaviorSubject('CREATED');
        this._atomUpdateSubjects[subscriberId] = atomStateSubject;
        var timeout = setTimeout(function () {
            _this._socket.close();
            atomStateSubject.error('Socket timeout');
        }, 5000);
        this._socket
            .call('Atoms.getAtomStatusNotifications', {
            subscriberId: subscriberId,
            aid: atom.getAidString(),
        })
            .then(function (response) {
            var atomJSON = atommodel_1.RadixSerializer.toJSON(atom);
            return _this._socket.call('Atoms.submitAtom', atomJSON);
        })
            .then(function (response) {
            if (response.aid !== atom.getAidString()) {
                throw new Error("Local AID \"" + atom.getAidString() + "\" does not match that computed on the node \"" + response.aid + "\".\nThis is a radixdlt-js issue, please report this at https://github.com/radixdlt/radixdlt-js/issues . \nThe atom may or may not have been accepted by the node.\n                    ");
            }
            clearTimeout(timeout);
            atomStateSubject.next('SUBMITTED');
        })
            .catch(function (error) {
            clearTimeout(timeout);
            atomStateSubject.error(error);
        });
        return atomStateSubject;
    };
    /**
     * NOT IMPLEMENTED
     * Query the ledger for an atom by its id
     * @param id
     * @returns The atom
     */
    RadixNodeConnection.prototype.getAtomById = function (id) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                // TODO: everything
                return [2 /*return*/, this._socket
                        .call('Atoms.getAtomInfo', { id: id.toJSON() })
                        .then(function (response) {
                        return atommodel_1.RadixSerializer.fromJSON(response.result);
                    })];
            });
        });
    };
    return RadixNodeConnection;
}(events_1.default.EventEmitter));
exports.RadixNodeConnection = RadixNodeConnection;
exports.default = RadixNodeConnection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmFkaXhOb2RlQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL3VuaXZlcnNlL1JhZGl4Tm9kZUNvbm5lY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOEJBQWtEO0FBQ2xELGlEQUF1QztBQUd2QywwQ0FBcUc7QUFDckcscURBQThDO0FBRTlDLDBEQUEyQjtBQWtDM0I7SUFBeUMsK0NBQW1CO0lBYXhELDZCQUFxQixJQUFlO1FBQXBDLFlBQ0ksaUJBQU8sU0FFVjtRQUhvQixVQUFJLEdBQUosSUFBSSxDQUFXO1FBVDVCLG9CQUFjLEdBQXlELEVBQUUsQ0FBQTtRQUN6RSx5QkFBbUIsR0FBcUQsRUFBRSxDQUFBO1FBRTFFLDJCQUFxQixHQUFrQyxFQUFFLENBQUE7UUFFekQsc0JBQWdCLEdBQUcsQ0FBQyxDQUFBO1FBc0JwQixVQUFJLEdBQUc7WUFDWCxJQUFJLEtBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDaEIsS0FBSSxDQUFDLE9BQU87cUJBQ1AsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLFFBQWE7b0JBQ3hDLG9CQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQTtnQkFDbEMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsS0FBVTtvQkFDaEIsb0JBQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLENBQUE7Z0JBQzVDLENBQUMsQ0FBQyxDQUFBO2FBQ1Q7UUFDTCxDQUFDLENBQUE7UUFpTk0sV0FBSyxHQUFHO1lBQ1gsS0FBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQTtZQUVwQixhQUFhLENBQUMsS0FBSSxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBQ3BDLENBQUMsQ0FBQTtRQUVPLGVBQVMsR0FBRztZQUNo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