{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar tslib_1 = require(\"tslib\");\nvar __1 = require(\"../..\");\nvar atommodel_1 = require(\"../atommodel\");\nvar rxjs_1 = require(\"rxjs\");\nvar typescript_map_1 = require(\"typescript-map\");\nvar operators_1 = require(\"rxjs/operators\");\nvar RadixTokenDefinition_1 = require(\"./RadixTokenDefinition\");\n/**\n * A singleton class for loading information about tokens\n */\nvar RadixTokenManager = /** @class */function () {\n  function RadixTokenManager() {\n    this.tokens = {};\n    this.tokenSubscriptions = new typescript_map_1.TSMap();\n    this.accounts = new typescript_map_1.TSMap();\n    this.allTokenUpdateSubject = new rxjs_1.Subject();\n    this.initialized = false;\n  }\n  RadixTokenManager.prototype.initialize = function (genesis, nativeToken) {\n    var e_1, _a;\n    this.nativeToken = nativeToken;\n    var systemAccount = new __1.RadixAccount(nativeToken.address);\n    try {\n      for (var genesis_1 = tslib_1.__values(genesis), genesis_1_1 = genesis_1.next(); !genesis_1_1.done; genesis_1_1 = genesis_1.next()) {\n        var atom = genesis_1_1.value;\n        systemAccount._onAtomReceived({\n          action: 'STORE',\n          atom: atom,\n          processedData: {},\n          isHead: false\n        });\n      }\n    } catch (e_1_1) {\n      e_1 = {\n        error: e_1_1\n      };\n    } finally {\n      try {\n        if (genesis_1_1 && !genesis_1_1.done && (_a = genesis_1.return)) _a.call(genesis_1);\n      } finally {\n        if (e_1) throw e_1.error;\n      }\n    }\n    this.accounts.set(systemAccount.getAddress(), systemAccount);\n    this.addTokenDefinitionSubscription(nativeToken.toString());\n    this.initialized = true;\n  };\n  RadixTokenManager.prototype.getTokenDefinitionObservable = function (referenceURI) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.checkInitialized();\n            if (!!this.tokenSubscriptions.has(referenceURI)) return [3 /*break*/, 2];\n            return [4 /*yield*/, this.addTokenDefinitionSubscription(referenceURI)];\n          case 1:\n            _a.sent();\n            _a.label = 2;\n          case 2:\n            return [2 /*return*/, this.tokenSubscriptions.get(referenceURI).share()];\n        }\n      });\n    });\n  };\n  RadixTokenManager.prototype.addTokenDefinitionSubscription = function (referenceURI) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var reference, account, placeholderTokenDefinition, bs;\n      var _this = this;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            reference = atommodel_1.RRI.fromString(referenceURI);\n            return [4 /*yield*/, this.getAccount(reference.getAddress())];\n          case 1:\n            account = _a.sent();\n            placeholderTokenDefinition = new RadixTokenDefinition_1.RadixTokenDefinition(reference.getAddress(), reference.getName());\n            bs = new rxjs_1.BehaviorSubject(placeholderTokenDefinition);\n            account.tokenDefinitionSystem.getTokenDefinitionObservable(reference.getName()).subscribe(bs);\n            this.tokenSubscriptions.set(referenceURI, bs);\n            bs.subscribe(function (tokenDefinition) {\n              _this.tokens[referenceURI] = tokenDefinition;\n            });\n            bs.subscribe(this.allTokenUpdateSubject);\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  RadixTokenManager.prototype.getTokenDefinition = function (referenceURI) {\n    var _this = this;\n    this.checkInitialized();\n    return new Promise(function (resolve, reject) {\n      var reference = atommodel_1.RRI.fromString(referenceURI);\n      _this.getAccount(reference.getAddress()).then(function (account) {\n        account.isSynced().pipe(operators_1.filter(function (val) {\n          return val === true;\n        }), operators_1.take(1), operators_1.timeout(5000)).subscribe(null, function (error) {\n          reject(new Error('Timeout tying to fetch token information from network'));\n        }, function () {\n          // Account is synced\n          var tokenDefinition = account.tokenDefinitionSystem.getTokenDefinition(reference.getName());\n          if (tokenDefinition) {\n            resolve(tokenDefinition);\n          } else {\n            reject(new Error('Token definition does not exist in the account'));\n          }\n        });\n      });\n    });\n  };\n  RadixTokenManager.prototype.getTokenDefinitionNoLoad = function (referenceURI) {\n    return this.tokens[referenceURI];\n  };\n  RadixTokenManager.prototype.getAccount = function (address) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var account;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!this.accounts.has(address.toString())) return [3 /*break*/, 1];\n            return [2 /*return*/, this.accounts.get(address.toString())];\n          case 1:\n            account = new __1.RadixAccount(address);\n            return [4 /*yield*/, account.openNodeConnection()];\n          case 2:\n            _a.sent();\n            this.accounts.set(address.toString(), account);\n            return [2 /*return*/, account];\n        }\n      });\n    });\n  };\n  RadixTokenManager.prototype.checkInitialized = function () {\n    if (!this.initialized) {\n      throw new Error('Token Manager not initialized');\n    }\n  };\n  RadixTokenManager.prototype.getAllTokenDefinitionUpdates = function () {\n    return this.allTokenUpdateSubject.share();\n  };\n  /**\n   * Return a list of the current tokens in the manager.\n   *\n   * @returns\n   * @memberof RadixToken\n   */\n  RadixTokenManager.prototype.getCurrentTokens = function () {\n    this.checkInitialized();\n    return this.tokens;\n  };\n  return RadixTokenManager;\n}();\nexports.RadixTokenManager = RadixTokenManager;\nexports.radixTokenManager = new RadixTokenManager();","map":{"version":3,"names":["__1","require","atommodel_1","rxjs_1","typescript_map_1","operators_1","RadixTokenDefinition_1","RadixTokenManager","tokens","tokenSubscriptions","TSMap","accounts","allTokenUpdateSubject","Subject","initialized","prototype","initialize","genesis","nativeToken","systemAccount","RadixAccount","address","genesis_1","tslib_1","__values","genesis_1_1","next","done","atom","value","_onAtomReceived","action","processedData","isHead","set","getAddress","addTokenDefinitionSubscription","toString","getTokenDefinitionObservable","referenceURI","checkInitialized","has","_a","sent","get","share","reference","RRI","fromString","getAccount","account","placeholderTokenDefinition","RadixTokenDefinition","getName","bs","BehaviorSubject","tokenDefinitionSystem","subscribe","tokenDefinition","_this","getTokenDefinition","Promise","resolve","reject","then","isSynced","pipe","filter","val","take","timeout","error","Error","getTokenDefinitionNoLoad","openNodeConnection","getAllTokenDefinitionUpdates","getCurrentTokens","exports","radixTokenManager"],"sources":["../../../../src/modules/token/RadixTokenManager.ts"],"sourcesContent":[null],"mappings":";;;;;;AAAA,IAAAA,GAAA,GAAAC,OAAA;AACA,IAAAC,WAAA,GAAAD,OAAA;AACA,IAAAE,MAAA,GAAAF,OAAA;AACA,IAAAG,gBAAA,GAAAH,OAAA;AACA,IAAAI,WAAA,GAAAJ,OAAA;AACA,IAAAK,sBAAA,GAAAL,OAAA;AAEA;;;AAGA,IAAAM,iBAAA;EAAA,SAAAA,kBAAA;IACW,KAAAC,MAAM,GAA2C,EAAE;IAElD,KAAAC,kBAAkB,GAAyD,IAAIL,gBAAA,CAAAM,KAAK,EAAE;IACvF,KAAAC,QAAQ,GAAgC,IAAIP,gBAAA,CAAAM,KAAK,EAAE;IAClD,KAAAE,qBAAqB,GAAkC,IAAIT,MAAA,CAAAU,OAAO,EAAE;IAIpE,KAAAC,WAAW,GAAG,KAAK;EAqH/B;EAnHWP,iBAAA,CAAAQ,SAAA,CAAAC,UAAU,GAAjB,UAAkBC,OAAoB,EAAEC,WAAgB;;IACpD,IAAI,CAACA,WAAW,GAAGA,WAAW;IAE9B,IAAMC,aAAa,GAAG,IAAInB,GAAA,CAAAoB,YAAY,CAACF,WAAW,CAACG,OAAO,CAAC;;MAE3D,KAAmB,IAAAC,SAAA,GAAAC,OAAA,CAAAC,QAAA,CAAAP,OAAO,GAAAQ,WAAA,GAAAH,SAAA,CAAAI,IAAA,KAAAD,WAAA,CAAAE,IAAA,EAAAF,WAAA,GAAAH,SAAA,CAAAI,IAAA,IAAE;QAAvB,IAAME,IAAI,GAAAH,WAAA,CAAAI,KAAA;QACXV,aAAa,CAACW,eAAe,CAAC;UAC1BC,MAAM,EAAE,OAAO;UACfH,IAAI,EAAAA,IAAA;UACJI,aAAa,EAAE,EAAE;UACjBC,MAAM,EAAE;SACX,CAAC;;;;;;;;;;;;;IAGN,IAAI,CAACtB,QAAQ,CAACuB,GAAG,CAACf,aAAa,CAACgB,UAAU,EAAE,EAAEhB,aAAa,CAAC;IAE5D,IAAI,CAACiB,8BAA8B,CAAClB,WAAW,CAACmB,QAAQ,EAAE,CAAC;IAE3D,IAAI,CAACvB,WAAW,GAAG,IAAI;EAC3B,CAAC;EAEYP,iBAAA,CAAAQ,SAAA,CAAAuB,4BAA4B,GAAzC,UAA0CC,YAAoB;;;;;YAC1D,IAAI,CAACC,gBAAgB,EAAE;iBAEnB,CAAC,IAAI,CAAC/B,kBAAkB,CAACgC,GAAG,CAACF,YAAY,CAAC,EAA1C;YACA,qBAAM,IAAI,CAACH,8BAA8B,CAACG,YAAY,CAAC;;YAAvDG,EAAA,CAAAC,IAAA,EAAuD;;;YAG3D,sBAAO,IAAI,CAAClC,kBAAkB,CAACmC,GAAG,CAACL,YAAY,CAAC,CAACM,KAAK,EAAE;;;;GAC3D;EAEatC,iBAAA,CAAAQ,SAAA,CAAAqB,8BAA8B,GAA5C,UAA6CG,YAAoB;;;;;;;YACvDO,SAAS,GAAG5C,WAAA,CAAA6C,GAAG,CAACC,UAAU,CAACT,YAAY,CAAC;YAC9B,qBAAM,IAAI,CAACU,UAAU,CAACH,SAAS,CAACX,UAAU,EAAE,CAAC;;YAAvDe,OAAO,GAAGR,EAAA,CAAAC,IAAA,EAA6C;YAEvDQ,0BAA0B,GAAG,IAAI7C,sBAAA,CAAA8C,oBAAoB,CAACN,SAAS,CAACX,UAAU,EAAE,EAAEW,SAAS,CAACO,OAAO,EAAE,CAAC;YAElGC,EAAE,GAAG,IAAInD,MAAA,CAAAoD,eAAe,CAACJ,0BAA0B,CAAC;YAE1DD,OAAO,CAACM,qBAAqB,CAAClB,4BAA4B,CAACQ,SAAS,CAACO,OAAO,EAAE,CAAC,CAACI,SAAS,CAACH,EAAE,CAAC;YAE7F,IAAI,CAAC7C,kBAAkB,CAACyB,GAAG,CAACK,YAAY,EAAEe,EAAE,CAAC;YAE7CA,EAAE,CAACG,SAAS,CAAC,UAAAC,eAAe;cACxBC,KAAI,CAACnD,MAAM,CAAC+B,YAAY,CAAC,GAAGmB,eAAe;YAC/C,CAAC,CAAC;YAEFJ,EAAE,CAACG,SAAS,CAAC,IAAI,CAAC7C,qBAAqB,CAAC;;;;;GAC3C;EAEML,iBAAA,CAAAQ,SAAA,CAAA6C,kBAAkB,GAAzB,UAA0BrB,YAAoB;IAA9C,IAAAoB,KAAA;IACI,IAAI,CAACnB,gBAAgB,EAAE;IAEvB,OAAO,IAAIqB,OAAO,CAAC,UAACC,OAAO,EAAEC,MAAM;MAE/B,IAAMjB,SAAS,GAAG5C,WAAA,CAAA6C,GAAG,CAACC,UAAU,CAACT,YAAY,CAAC;MAC9CoB,KAAI,CAACV,UAAU,CAACH,SAAS,CAACX,UAAU,EAAE,CAAC,CAAC6B,IAAI,CAAC,UAACd,OAAO;QACjDA,OAAO,CAACe,QAAQ,EAAE,CAACC,IAAI,CACnB7D,WAAA,CAAA8D,MAAM,CAAC,UAAAC,GAAG;UAAI,OAAAA,GAAG,KAAK,IAAI;QAAZ,CAAY,CAAC,EAC3B/D,WAAA,CAAAgE,IAAI,CAAC,CAAC,CAAC,EACPhE,WAAA,CAAAiE,OAAO,CAAC,IAAI,CAAC,CAChB,CAACb,SAAS,CACP,IAAI,EACJ,UAAAc,KAAK;UAAKR,MAAM,CAAC,IAAIS,KAAK,CAAC,uDAAuD,CAAC,CAAC;QAAA,CAAC,EACrF;UACI;UACA,IAAMd,eAAe,GAAGR,OAAO,CAACM,qBAAqB,CAACI,kBAAkB,CAACd,SAAS,CAACO,OAAO,EAAE,CAAC;UAE7F,IAAIK,eAAe,EAAE;YACjBI,OAAO,CAACJ,eAAe,CAAC;WAC3B,MAAM;YACHK,MAAM,CAAC,IAAIS,KAAK,CAAC,gDAAgD,CAAC,CAAC;;QAE3E,CAAC,CACJ;MACL,CAAC,CAAC;IACN,CAAC,CAAC;EACN,CAAC;EAEMjE,iBAAA,CAAAQ,SAAA,CAAA0D,wBAAwB,GAA/B,UAAgClC,YAAoB;IAChD,OAAO,IAAI,CAAC/B,MAAM,CAAC+B,YAAY,CAAC;EACpC,CAAC;EAEahC,iBAAA,CAAAQ,SAAA,CAAAkC,UAAU,GAAxB,UAAyB5B,OAAqB;;;;;;iBACtC,IAAI,CAACV,QAAQ,CAAC8B,GAAG,CAACpB,OAAO,CAACgB,QAAQ,EAAE,CAAC,EAArC;YACA,sBAAO,IAAI,CAAC1B,QAAQ,CAACiC,GAAG,CAACvB,OAAO,CAACgB,QAAQ,EAAE,CAAC;;YAEtCa,OAAO,GAAG,IAAIlD,GAAA,CAAAoB,YAAY,CAACC,OAAO,CAAC;YACzC,qBAAM6B,OAAO,CAACwB,kBAAkB,EAAE;;YAAlChC,EAAA,CAAAC,IAAA,EAAkC;YAClC,IAAI,CAAChC,QAAQ,CAACuB,GAAG,CAACb,OAAO,CAACgB,QAAQ,EAAE,EAAEa,OAAO,CAAC;YAC9C,sBAAOA,OAAO;;;;GAErB;EAEO3C,iBAAA,CAAAQ,SAAA,CAAAyB,gBAAgB,GAAxB;IACI,IAAI,CAAC,IAAI,CAAC1B,WAAW,EAAE;MACnB,MAAM,IAAI0D,KAAK,CAAC,+BAA+B,CAAC;;EAExD,CAAC;EAEMjE,iBAAA,CAAAQ,SAAA,CAAA4D,4BAA4B,GAAnC;IACI,OAAO,IAAI,CAAC/D,qBAAqB,CAACiC,KAAK,EAAE;EAC7C,CAAC;EAED;;;;;;EAMOtC,iBAAA,CAAAQ,SAAA,CAAA6D,gBAAgB,GAAvB;IACI,IAAI,CAACpC,gBAAgB,EAAE;IAEvB,OAAO,IAAI,CAAChC,MAAM;EACtB,CAAC;EACL,OAAAD,iBAAC;AAAD,CAAC,CA9HD;AAAasE,OAAA,CAAAtE,iBAAA,GAAAA,iBAAA;AAgIFsE,OAAA,CAAAC,iBAAiB,GAAG,IAAIvE,iBAAiB,EAAE","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}